{%- set pageTitle = (site.site_name if page.url === '/' else title + ' | ' + site.site_name) | safe -%}
{%- set pageDsc = (description or site.site_desc) | safe -%}
<!DOCTYPE html>
<html lang="en">
<head>
  {# preload font? #}
  <meta charset="utf-8">
  <meta name="format-detection" content="telephone=no" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
  <title>{{ pageTitle }}</title>
  {# meta-desc #}
    <meta name="description" content="{{ pageDsc }}" />
  {# icon tags #}
    <link rel="icon" type="image/png" href="{% imgPath '/assets/sjifire-logo-clear.png' %}" />
  {# og #}
    <meta property="og:url" content="{{ site.prodUrl + page.url}}" key="ogurl" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="
      {%- if page.fileSlug === 'news-article' and post.featured_image and post.featured_image.source %}
        {%- imgPath '/assets/media/' + post.featured_image.source, 'f_auto,q_auto:good,c_fill,w_1200,h_630' -%}
      {% else %}
        {%- imgPath '/assets/media/' + site.opengraph_image, 'f_auto,q_auto:good,c_fill,w_1200,h_630' -%}
      {% endif -%}" key="ogimage" />
    <meta property="og:site_name" content="{{site.site_name}}" key="ogsitename" />
    <meta property="og:title" content="{{pageTitle}}" key="ogtitle" />
    <meta property="og:description" content="{{ pageDsc }}" key="ogdesc" />
    <link rel="preconnect" href="//google-analytics.com" />
    <link rel="preconnect" href="//googleapis.com" />
    <link rel="preconnect" href="//gstatic.com" />
    <link rel="preconnect" href="//googletagmanager.com" />
    <link rel="preconnect" href="//clarity.ms/ "/>

  <link rel="stylesheet" href="/css/site.css">
</head>
<body>

  {% include "svg-sprite.svg" %}

  <header id="home-header" class="site-header{{ ' site-header--home' if page.url === '/'}}" role="banner">
    {% include "header.njk" %}
  </header>

  {% if page.fileSlug === 'news-article' and post.featured_image and post.featured_image.source != "" %}
    <figure class="featured__media">
      <img src="{% imgPath '/assets/media/' + post.featured_image.source, 'f_auto,c_limit,w_900,h_500' %}" alt="{{ post.featured_image.alt }}" loading="eager">
    </figure>
  {% endif %}

  <main id='site-main' class="site-main{{ ' site-main--overlap' if page.url === '/' }}" role="main">
    <div class="rap">
      {% block content %}
        {{ content | safe }}
      {% endblock %}
    </div>
  </main>

  <footer class="site-footer" role="contentinfo">
    <div class="rap">
      {% include "footer.njk" %}
    </div>
  </footer>
  {% set js %}
    {% include "nav-js.njk" %}
    {% if page.url === '/' %}
      const imgs = {{ header_image_source | headerImageUrls(header_image_transform) | safe }};
      const image = imgs[Math.floor(Math.random() * imgs.length)];
      document.getElementById('home-header').style.setProperty('--home-header-bg-image', 'url('+image+')');
    {% endif %}

    // Image Carousel
    (function() {
      const carousel = document.querySelector('.carousel');
      if (!carousel) return;

      const slides = carousel.querySelectorAll('.carousel__slide');
      const dots = carousel.querySelectorAll('.carousel__dot');
      const thumbs = carousel.querySelectorAll('.carousel__thumb');
      const prevBtn = carousel.querySelector('.carousel__btn--prev');
      const nextBtn = carousel.querySelector('.carousel__btn--next');

      const autoplay = carousel.dataset.autoplay === 'true';
      const interval = (parseInt(carousel.dataset.interval, 10) || 5) * 1000;

      let currentIndex = 0;
      let autoplayTimer = null;
      let isPaused = false;

      function goToSlide(index) {
        if (index < 0) index = slides.length - 1;
        if (index >= slides.length) index = 0;

        slides[currentIndex].classList.remove('active');
        dots[currentIndex]?.classList.remove('active');
        thumbs[currentIndex]?.classList.remove('active');

        currentIndex = index;

        slides[currentIndex].classList.add('active');
        dots[currentIndex]?.classList.add('active');
        thumbs[currentIndex]?.classList.add('active');
      }

      function nextSlide() {
        goToSlide(currentIndex + 1);
      }

      function prevSlide() {
        goToSlide(currentIndex - 1);
      }

      function startAutoplay() {
        if (autoplay && !isPaused) {
          autoplayTimer = setInterval(nextSlide, interval);
        }
      }

      function stopAutoplay() {
        if (autoplayTimer) {
          clearInterval(autoplayTimer);
          autoplayTimer = null;
        }
      }

      // Event listeners
      prevBtn?.addEventListener('click', () => {
        prevSlide();
        stopAutoplay();
        startAutoplay();
      });

      nextBtn?.addEventListener('click', () => {
        nextSlide();
        stopAutoplay();
        startAutoplay();
      });

      dots.forEach((dot, index) => {
        dot.addEventListener('click', () => {
          goToSlide(index);
          stopAutoplay();
          startAutoplay();
        });
      });

      thumbs.forEach((thumb, index) => {
        thumb.addEventListener('click', () => {
          goToSlide(index);
          stopAutoplay();
          startAutoplay();
        });
      });

      // Pause on hover
      carousel.addEventListener('mouseenter', () => {
        isPaused = true;
        stopAutoplay();
      });

      carousel.addEventListener('mouseleave', () => {
        isPaused = false;
        startAutoplay();
      });

      // Keyboard navigation
      carousel.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') {
          prevSlide();
          stopAutoplay();
          startAutoplay();
        } else if (e.key === 'ArrowRight') {
          nextSlide();
          stopAutoplay();
          startAutoplay();
        }
      });

      // Start autoplay
      startAutoplay();
    })();
  {% endset %}
  <script defer>
    {{ js | jsmin | safe }}
  </script>
</body>
</html>
